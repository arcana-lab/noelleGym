#!/bin/bash -e

prefixString="### NOELLE Gym: Compile ###" ;
echo "${prefixString} All benchmarks from all benchmark suites will be compiled" ;
echo "${prefixString} Results will be stored in `pwd`/results/current_machine" ;
echo "${prefixString} The output of each step will be stored in `pwd`/output.txt" ;
echo "${prefixString}     (you can run \"tail -f output.txt\" to see the current state at finer granularity)" ;
echo "" ;

# Setup
echo "${prefixString}   Setup" ;
./bin/setup >> output.txt 2>&1 ;

# Configure NOELLE
source NOELLE/enable ;
export NOELLE_CORES=8 ;

# Compile all benchmarks
echo "${prefixString}   Start compiling all benchmarks for all configurations (with condor)";
./scripts/condor/compile_benchmarks.sh >> output.txt 2>&1 ;
echo "${prefixString}     All benchmarks have been compiled for enablers-only and DOALL" ;

# Compile using DOALL 
echo "${prefixString}   Start generating parallelized binaries";
./scripts/condor/optimize_benchmarks.sh "DOALL" "default" >> output.txt 2>&1 ;
echo "${prefixString}     All benchmarks have been compiled for DOALL" ;

# Compile using HELIX
./scripts/condor/optimize_benchmarks.sh "HELIX" "default" >> output.txt 2>&1 ;
echo "${prefixString}     All benchmarks have been compiled for HELIX" ;

# Compile using DSWP
./scripts/condor/optimize_benchmarks.sh "DSWP" "default" >> output.txt 2>&1 ;
echo "${prefixString}     All benchmarks have been compiled for DSWP" ;

# Compile using enablers
./scripts/condor/optimize_benchmarks.sh "NONE" "default" >> output.txt 2>&1 ;
echo "${prefixString}     All benchmarks have been compiled for NONE" ;

# Compile using AUTOTUNER
./scripts/condor/optimize_benchmarks.sh "AUTOTUNER" "default" >> output.txt 2>&1 ;
echo "${prefixString}     All benchmarks have been compiled for AUTOTUNER" ;

# Clean
echo "${prefixString}   Clean" ;
./scripts/clean.sh >> output.txt 2>&1 ;

echo "${prefixString} Exit" ;
